<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Product</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container mt-4">
  <a href="index.html">← Back to catalog</a>
  <div id="product" class="row mt-3"></div>

  <hr>
  <h5>Reviews</h5>
  <div id="reviews"></div>

  <div id="review-form" class="mt-4" style="display:none">
    <h6>Leave a review</h6>
    <select id="reviewRating" class="form-select mb-2" style="width:120px">
      <option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option>
    </select>
    <textarea id="reviewComment" class="form-control mb-2" rows="3" placeholder="Your comment"></textarea>
    <button id="submitReview" class="btn btn-primary">Submit Review</button>
  </div>
  <div id="loginNote" class="mt-3"></div>
</div>

<script src="js/app.js"></script>
<script src="js/auth.js"></script>
<script>
  const params = new URLSearchParams(location.search);
  const productId = params.get('id');
  if (!productId) { alert('No product id'); location='index.html'; }

  async function loadProduct(){
    const p = await getProduct(productId);
    const container = document.getElementById('product');
    container.innerHTML = `
      <div class="col-md-4"><img src="${p.imageUrl}" class="img-fluid"></div>
      <div class="col-md-8">
        <h3>${p.name}</h3>
        <p>${p.description}</p>
        <p><strong>$${p.price}</strong></p>
        <p>Rating: ${p.ratingAvg?.toFixed(1) || 0} (${p.ratingCount || 0})</p>
        <p>${renderTags(p.tags)}</p>
        <button class="btn btn-primary" onclick="addToCart(${p.id},1)">Add to cart</button>
        <button class="btn btn-outline-secondary" onclick="addToWishlist(${p.id})">♡ Wishlist</button>
      </div>`;
  }

  async function loadReviews(){
    const res = await fetch(`${API_BASE}/reviews/product/${productId}`);
    if (res.ok){
      const list = await res.json();
      const el = document.getElementById('reviews');
      el.innerHTML = list.map(r=>`<div class="border p-2 mb-2"><strong>${r.user.username}</strong> — ${r.rating}/5<br>${r.comment}</div>`).join('');
    }
  }

  loadProduct(); loadReviews();

  // review form visibility
  if (isLoggedIn()){
    document.getElementById('review-form').style.display = 'block';
    document.getElementById('submitReview').addEventListener('click', async ()=>{
      const rating = parseInt(document.getElementById('reviewRating').value);
      const comment = document.getElementById('reviewComment').value.trim();
      const token = localStorage.getItem('token');
      const res = await fetch(`${API_BASE}/reviews/add/${productId}`, {
        method:'POST', headers: {'Content-Type':'application/json','Authorization':'Bearer '+token},
        body: JSON.stringify({rating, comment})
      });
      if (res.ok){ alert('Review submitted'); document.getElementById('reviewComment').value=''; loadReviews(); loadProduct(); }
      else alert('Failed to submit review');
    });
  } else {
    document.getElementById('loginNote').innerHTML = `<a href="login.html">Login</a> to leave a review.`;
  }
</script>
</body>
</html>
