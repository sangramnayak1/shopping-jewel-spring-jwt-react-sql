<!doctype html>
<html>
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sandbox Payment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <h3>Sandbox Payment</h3>
  <p>This will build an order from current cart items and call /api/orders/place. Use the toggle to force success/fail.</p>
  <div class="mb-3">
    <label class="form-check-label me-2"><input id="forceSuccess" type="radio" name="result" checked> Force Success</label>
    <label class="form-check-label"><input id="forceFail" type="radio" name="result"> Force Fail</label>
  </div>
  <button id="payBtn" class="btn btn-success">Pay</button>
</div>

<script>
async function getCartItems(){
  const token = localStorage.getItem('token');
  const res = await fetch('http://localhost:8080/api/cart', {headers:{'Authorization':'Bearer '+token}});
  if (!res.ok) return [];
  return await res.json();
}

document.getElementById('payBtn').addEventListener('click', async ()=>{
  const token = localStorage.getItem('token');
  const items = await getCartItems();
  if (!items || items.length===0){ alert('Cart empty'); return; }
  // construct order items by fetching product details for each cart item
  const orderItems = [];
  for (const c of items){
    const pRes = await fetch(`http://localhost:8080/api/products/${c.productId}`);
    const p = await pRes.json();
    orderItems.push({ product: p, quantity: c.quantity, unitPrice: p.price });
  }
  // Force success/fail by tweaking total amount cents odd/even:
  let total = orderItems.reduce((s,i)=>s + i.unitPrice * i.quantity, 0);
  // if forceFail selected, add 0.01 to make cents odd
  if (document.getElementById('forceFail').checked) total = Math.round((total*100))/100 + 0.01;
  // place order
  const order = { items: orderItems, totalAmount: total };
  const res = await fetch('http://localhost:8080/api/orders/place', {method:'POST', headers:{'Content-Type':'application/json','Authorization':'Bearer '+token}, body: JSON.stringify(order)});
  if (res.ok){ const o = await res.json(); alert('Order placed: ' + o.status + ' ('+o.paymentReference+')'); window.location='order-history.html'; }
  else { alert('Order failed'); }
});
</script>
</body>
</html>
